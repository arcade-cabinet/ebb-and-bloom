/**
 * Catalyst Creator - UIKit version
 * Trait allocation interface
 */

import { Container, Fullscreen, Text } from '@react-three/uikit';
import { Button, Card, CardContent, Progress } from '@react-three/uikit-default';
import { useState } from 'react';
import { log } from '../utils/Logger';

export interface TraitAllocation {
    mobility: number;
    manipulation: number;
    excavation: number;
    social: number;
    sensing: number;
    illumination: number;
    storage: number;
    filtration: number;
    defense: number;
    toxicity: number;
}

interface CatalystCreatorProps {
    onComplete: (traits: TraitAllocation) => void;
    onSkip?: () => void;
}

const TRAIT_NAMES: (keyof TraitAllocation)[] = [
    'mobility', 'manipulation', 'excavation', 'social', 'sensing',
    'illumination', 'storage', 'filtration', 'defense', 'toxicity'
];

const TRAIT_ICONS: Record<keyof TraitAllocation, string> = {
    mobility: 'üèÉ', manipulation: 'ü§≤', excavation: '‚õèÔ∏è', social: 'ü§ù', sensing: 'üëÅÔ∏è',
    illumination: 'üí°', storage: 'üéí', filtration: 'ü´Å', defense: 'üõ°Ô∏è', toxicity: '‚ò†Ô∏è'
};

const CatalystCreator: React.FC<CatalystCreatorProps> = ({ onComplete, onSkip }) => {
    const [traits, setTraits] = useState<TraitAllocation>({
        mobility: 0, manipulation: 0, excavation: 0, social: 0, sensing: 0,
        illumination: 0, storage: 0, filtration: 0, defense: 0, toxicity: 0
    });

    const TOTAL_POINTS = 10;
    const allocatedPoints = Object.values(traits).reduce((sum, val) => sum + val, 0);
    const remainingPoints = TOTAL_POINTS - allocatedPoints;

    const adjustTrait = (trait: keyof TraitAllocation, delta: number) => {
        const newValue = Math.max(0, Math.min(10, traits[trait] + delta));
        const newTotal = allocatedPoints - traits[trait] + newValue;

        if (newTotal <= TOTAL_POINTS) {
            setTraits({ ...traits, [trait]: newValue });
        }
    };

    const handleComplete = () => {
        if (remainingPoints === 0) {
            log.info('Catalyst created', { traits });
            onComplete(traits);
        }
    };

    return (
        <Fullscreen
            backgroundColor={0x1a202c}
            opacity={0.95}
            overflow="scroll"
            padding={32}
        >
            <Container flexDirection="column" alignItems="center" gap={24} width="100%">
                {/* Title */}
                <Text  fontSize={36} fontWeight="bold" color={0xD69E2E}>
                    Create Your Catalyst
                </Text>
                <Text fontFamily="inter" fontSize={18} color={0xA0AEC0}>
                    Allocate 10 Evo Points across evolutionary traits
                </Text>

                {/* Points Remaining */}
                <Card padding={16} backgroundColor={0xD69E2E} opacity={0.8}>
                    <Container flexDirection="row" alignItems="center" gap={12}>
                        <Text fontSize={20}>‚ö°</Text>
                        <Container flexDirection="column">
                            <Text fontFamily="inter" fontSize={12} color={0xA0AEC0}>
                                Evo Points Remaining
                            </Text>
                            <Text  fontSize={32} fontWeight="bold" color={remainingPoints === 0 ? 0x38A169 : 0xD69E2E}>
                                {remainingPoints}
                            </Text>
                        </Container>
                    </Container>
                </Card>

                {/* Trait Grid */}
                <Container
                    flexDirection="row"
                    flexWrap="wrap"
                    gap={16}
                    justifyContent="center"
                    maxWidth={900}
                >
                    {TRAIT_NAMES.map(trait => (
                        <Card key={trait} width={280} padding={16}>
                            <CardContent flexDirection="column" gap={12}>
                                <Container flexDirection="row" alignItems="center" gap={8}>
                                    <Text fontSize={24}>{TRAIT_ICONS[trait]}</Text>
                                    <Text fontFamily="inter" fontSize={16} fontWeight="medium" color={0x38A169}>
                                        {trait.charAt(0).toUpperCase() + trait.slice(1)}
                                    </Text>
                                </Container>

                                <Container flexDirection="row" alignItems="center" gap={12} justifyContent="space-between">
                                    <Button
                                        onClick={() => adjustTrait(trait, -1)}
                                        disabled={traits[trait] === 0}
                                        size="sm"
                                        width={40}
                                    >
                                        <Text fontSize={18}>‚àí</Text>
                                    </Button>

                                    <Text  fontSize={24} fontWeight="bold" color={0xD69E2E}>
                                        {traits[trait]}
                                    </Text>

                                    <Button
                                        onClick={() => adjustTrait(trait, 1)}
                                        disabled={remainingPoints === 0}
                                        size="sm"
                                        width={40}
                                    >
                                        <Text fontSize={18}>+</Text>
                                    </Button>
                                </Container>

                                <Progress value={traits[trait] / 10} width="100%" />
                            </CardContent>
                        </Card>
                    ))}
                </Container>

                {/* Actions */}
                <Container flexDirection="row" gap={16} marginTop={32}>
                    {onSkip && (
                        <Button onClick={onSkip} variant="outline" paddingX={24} paddingY={16}>
                            <Text fontSize={16}>Skip</Text>
                        </Button>
                    )}
                    <Button
                        onClick={handleComplete}
                        disabled={remainingPoints > 0}
                        backgroundColor={remainingPoints === 0 ? 0x38A169 : 0x2d3748}
                        paddingX={32}
                        paddingY={16}
                    >
                        <Text fontSize={18} fontWeight="bold">
                            {remainingPoints === 0 ? 'Begin Evolution' : `Allocate ${remainingPoints} more points`}
                        </Text>
                    </Button>
                </Container>
            </Container>
        </Fullscreen>
    );
};

export default CatalystCreator;
