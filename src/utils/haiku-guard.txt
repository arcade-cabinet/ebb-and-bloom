// Snippet 1 - Context: - **Evo Ache**: Volume/pan ties to context—proximity inheritance: Soft, intimate swell (haptic light throb); nova reset: Fading echo (reverb tail to silence, journal haiku whispers over). Style skew: Harmony (+reverb warmth), conquest (+distortion grit), frolick (+random pitch warble for whimsy giggles). ### POC Sketches (Web Audio Tease) Quick runtime gen—paste into a Phaser scene for trait morphs. (Tested mentally; devs, tweak osc types for your atlas.)

// Web Audio Morph POC: Flipper to Tidal Scar
const audioCtx = new AudioContext();
const morph = () => {
  // Base: Flipper whoosh (sine swell)
  const osc1 = audioCtx.createOscillator(); osc1.type = 'sine'; osc1.frequency.setValueAtTime(200, audioCtx.currentTime); // Low hum
  const gain1 = audioCtx.createGain(); gain1.gain.setValueAtTime(0.3, audioCtx.currentTime); gain1.gain.exponentialRampToValueAtTime(0.1, audioCtx.currentTime + 0.5);
  osc1.connect(gain1).connect(audioCtx.destination);
  osc1.start();

  // Twist: Void gurgle (noise + low-pass, Perlin-mod pitch)
  const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.5, audioCtx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1; // White noise
  const noise = audioCtx.createBufferSource(); noise.buffer = buffer;
  const filter = audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.setValueAtTime(150, audioCtx.currentTime);
  const perlinMod = (t) => 0.5 + 0.5 * Math.sin(t * 0.1 + Math.random() * Math.PI); // Simple Perlin tease
  filter.frequency.setTargetAtTime(100 + perlinMod(0) * 100, audioCtx.currentTime + 0.25, 0.1); // Darken over morph
  noise.connect(filter).connect(gain1); noise.start(audioCtx.currentTime + 0.25); // Delay blend

  gain1.gain.exponentialRampToValueAtTime(0.05, audioCtx.currentTime + 1); // Fade ache
};

// Trigger on morph event
morph(); // Haptic sync: light throb easing to rumble

// ---

// Snippet 2 - Context: ### Haiku Scorer POC: Narrative Variety Guard To combat "haiku hangover" repetition, this POC uses Jaccard similarity (set-based keyword overlap) on procedural haikus. It scores 5 samples, flags pairs >20% overlap, and recommends diversification. Simple, no STEM libs—pure Python for quick dev integration (hook to journal gen: If avg >0.2, reroll with metaphor prompt like "thorn as lover"). #### POC Code (Python, ~50 lines)

from collections import Counter

# Sample haiku generator (5-7-5 syllable mock)
def generate_haiku(seed_phrase):
    lines = [
        f"{seed_phrase} whispers in the",
        "vein of forgotten echoes",
        "tides pull the light low"
    ]
    return ' '.join(lines)

# Generate 5 sample haikus with varying repetition
haikus = [
    generate_haiku("flipper"),
    generate_haiku("burr"),
    generate_haiku("flipper vein"),  # Repeat motif
    generate_haiku("tidal scar"),
    generate_haiku("flipper tide")   # High overlap
]

# Simple keyword overlap scorer (Jaccard similarity)
def jaccard_similarity(s1, s2):
    a = set(s1.lower().split())
    b = set(s2.lower().split())
    intersection = len(a.intersection(b))
    union = len(a.union(b))
    return intersection / union if union != 0 else 0

# Score: Avg pairwise similarity, flag >0.2 (20%)
def score_haikus(haikus, threshold=0.2):
    similarities = []
    flagged = []
    for i in range(len(haikus)):
        for j in range(i+1, len(haikus)):
            sim = jaccard_similarity(haikus[i], haikus[j])
            similarities.append(sim)
            if sim > threshold:
                flagged.append((i, j, sim))
    
    avg_sim = sum(similarities) / len(similarities) if similarities else 0
    return {
        'average_similarity': avg_sim,
        'flagged_pairs': flagged,  # (idx1, idx2, sim)
        'haikus': haikus,
        'recommendation': 'Diversify: Introduce unlikely metaphors (e.g., thorn as lover)' if avg_sim > threshold else 'Varied enough—evo aches fresh'
    }

result = score_haikus(haikus)
print(result)

// ---

// Snippet 3 - Context: To combat "haiku hangover" repetition, this POC uses Jaccard similarity (set-based keyword overlap) on procedural haikus. It scores 5 samples, flags pairs >20% overlap, and recommends diversification. Simple, no STEM libs—pure Python for quick dev integration (hook to journal gen: If avg >0.2, reroll with metaphor prompt like "thorn as lover"). #### POC Code (Python, ~50 lines) #### Sample Run Output

{'average_similarity': 0.25,
 'flagged_pairs': [(0, 2, 0.2857142857142857), (0, 4, 0.3333333333333333), (2, 4, 0.5)],
 'haikus': ['flipper whispers in the vein of forgotten echoes tides pull the light low',
  'burr whispers in the vein of forgotten echoes tides pull the light low',
  'flipper vein whispers in the vein of forgotten echoes tides pull the light low',
  'tidal scar whispers in the vein of forgotten echoes tides pull the light low',
  'flipper tide whispers in the vein of forgotten echoes tides pull the light low'],
 'recommendation': 'Diversify: Introduce unlikely metaphors (e.g., thorn as lover)'}

// ---

// Snippet 4 - Context:    - **Use Case**: Fuzzy search in procedural names (e.g., haiku similarity). #### Implementation Example (Python, via DP) To arrive at a solution for "kitten" vs "sitting":

def levenshtein(s1, s2):
    m, n = len(s1), len(s2)
    D = [[0] * (n+1) for _ in range(m+1)]
    for i in range(m+1): D[i][0] = i
    for j in range(n+1): D[0][j] = j
    for i in range(1, m+1):
        for j in range(1, n+1):
            cost = 0 if s1[i-1] == s2[j-1] else 1
            D[i][j] = min(D[i-1][j] + 1,      # delete
                          D[i][j-1] + 1,      # insert
                          D[i-1][j-1] + cost) # substitute
    return D[m][n]

print(levenshtein("kitten", "sitting"))  # Output: 3

// ---

// Snippet 5 - Context: #### 2. **Haiku Scorer Expansion: Journal Variety Guard (Narrative Ache)**    - **Why Expand?**: Stub's Python flags repetition; this ports to TS + integrates with Zustand for live evo checks (reroll if >0.2 Jaro-Winkler). Adds "metaphor bank" for diversity (thorn to lover, not echo).    - **Full Code**: `src/utils/haikuGuard.ts` (~180 lines).

// src/utils/haikuGuard.ts
import { useGameStore } from '../stores/game'; // Zustand tie

interface Haiku {
  text: string;
  keywords: string[];
}

const metaphorBank = {
  thorn: ['lover', 'whisper', 'tide', 'ache', 'bloom'],
  vein: ['memory', 'pulse', 'scar', 'hush', 'wake'],
  // Expand for evo diversity
};

class HaikuGuard {
  private threshold = 0.2; // Jaro-Winkler max

  // Jaro-Winkler similarity (full impl)
  jaroWinkler(s1: string, s2: string, p = 0.1, maxPrefix = 4): number {
    if (s1.length === 0 && s2.length === 0) return 1;
    if (s1.length === 0 || s2.length === 0) return 0;

    const window = Math.floor(Math.max(s1.length, s2.length) / 2) - 1;
    let match = 0, trans = 0;
    const s1Flags = new Array(s1.length).fill(false);
    const s2Flags = new Array(s2.length).fill(false);

    // Matching chars
    for (let i = 0; i < s1.length; i++) {
      const start = Math.max(0, i - window);
      for (let j = start; j < Math.min(s2.length, i + window + 1); j++) {
        if (s2Flags[j] || s1.charAt(i) !== s2.charAt(j)) continue;
        s1Flags[i] = s2Flags[j] = true;
        match++;
        break;
      }
    }

    // Transpositions
    for (let i = 0; i < s1.length; i++) {
      if (s1Flags[i]) {
        while (!s2Flags[i]) i++;
        if (s1.charAt(i) !== s2.charAt(i)) trans++;
      }
    }

    const jaro = match === 0 ? 0 : (1 / 3) * (match / s1.length + match / s2.length + (match - trans / 2) / match);

    // Prefix boost
    let prefix = 0;
    for (let i = 0; i < Math.min(maxPrefix, Math.min(s1.length, s2.length)); i++) {
      if (s1.charAt(i) === s2.charAt(i)) prefix++;
      else break;
    }

    return jaro + (prefix * p * (1 - jaro));
  }

  // Score recent haikus, flag >threshold
  scoreVariety(recent: Haiku[]): { avg: number; flagged: number[]; rec: string } {
    let total = 0, count = 0, flagged = 0;
    for (let i = 0; i < recent.length; i++) {
      for (let j = i + 1; j < recent.length; j++) {
        const sim = this.jaroWinkler(recent[i].text, recent[j].text);
        total += sim;
        count++;
        if (sim > this.threshold) flagged++;
      }
    }
    const avg = count > 0 ? total / count : 0;
    const rec = flagged > 0 ? `Diversify: Attune ${flagged} echoes with metaphor '${metaphorBank.thorn[Math.floor(Math.random() * metaphorBank.thorn.length)]}'` : 'Fresh ache—evo whispers true';
    return { avg, flagged, rec };
  }

  // Procedural haiku gen with guard (5-7-5 syllable mock)
  genHaiku(seedPhrase: string, evo: string): Haiku {
    const line1 = `${seedPhrase} whispers in the`; // 5 syllables
    const line2 = `vein of ${evo} echoes cold`; // 7
    const line3 = `tides pull the light low`; // 5
    const text = [line1, line2, line3].join(' ');
    const keywords = text.toLowerCase().split(' ').filter(w => w.length > 2);
    return { text, keywords };
  }

  // Hook for journal evo (Zustand)
  checkEvoHaiku(evo: string) {
    const store = useGameStore();
    const recent = store.journal.slice(-5);
    const candidate = this.genHaiku('flipper', evo); // Seed from trait
    const { avg } = this.scoreVariety([...recent, candidate]);
    if (avg > this.threshold) {
      // Reroll with metaphor
      const meta = metaphorBank['thorn'][Math.floor(Math.random() * metaphorBank.thorn.length)];
      const rerolled = this.genHaiku(meta, evo);
      store.journal.push(rerolled);
      return rerolled;
    }
    store.journal.push(candidate);
    return candidate;
  }
}

export const useHaikuGuard = () => new HaikuGuard();