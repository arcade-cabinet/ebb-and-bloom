name: AI Asset Generation Pipeline

on:
  workflow_dispatch:
    inputs:
      asset_type:
        description: 'Type of assets to generate'
        required: true
        default: 'archetypes'
        type: choice
        options:
          - archetypes
          - textures
          - all
      
  push:
    branches: [ main ]
    paths:
      - 'packages/gen/data/manifests/**'
      - 'packages/gen/src/prompts/**'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # Generate archetypes (gen0-gen6)
  generate-archetypes:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.asset_type == 'all' || github.event.inputs.asset_type == 'archetypes' || github.event.inputs.asset_type == '' }}
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
    
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    
    - run: pnpm install --frozen-lockfile
    
    - name: Generate All Archetypes
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        cd packages/gen
        pnpm cli archetypes
    
    - name: Run Quality Assessment
      run: |
        cd packages/gen
        pnpm cli quality || echo "Quality assessment completed"
    
    - name: Generate Documentation
      run: |
        cd packages/gen
        pnpm cli documentation || echo "Documentation generation completed"
    
    - uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: assets/archetypes-${{ github.run_id }}
        delete-branch: true
        title: "ðŸ§¬ Generate Archetypes (Gen0-Gen6)"
        body: |
          Automated archetype generation via OpenAI workflows.
          
          **Generations**: Gen0 (Planetary), Gen1 (Creatures), Gen2 (Packs), Gen3 (Tools), Gen4 (Tribes), Gen5 (Buildings), Gen6 (Religion/Democracy)
          
          **Idempotent**: Skips existing valid archetypes.
          
          **Quality**: Includes quality assessment and automatic regeneration of anemic archetypes.
        commit-message: "chore: generate archetypes via AI pipeline"
        labels: assets,archetypes,automated,ai-generated
  
  # Generate/download textures from AmbientCG
  generate-textures:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.asset_type == 'all' || github.event.inputs.asset_type == 'textures' || github.event.inputs.asset_type == '' }}
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
    
    - uses: pnpm/action-setup@v4
      with:
        version: ${{ env.PNPM_VERSION }}
    
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'
    
    - run: pnpm install --frozen-lockfile
    
    - name: Download AmbientCG Textures
      run: |
        cd packages/gen
        pnpm setup:textures || echo "Texture downloader not configured"
    
    - uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: assets/textures-${{ github.run_id }}
        delete-branch: true
        title: "ðŸŽ¨ Download AmbientCG Textures"
        body: |
          Automated texture download from AmbientCG library.
          
          **Idempotent**: Skips existing textures.
        commit-message: "chore: download AmbientCG textures"
        labels: assets,textures,automated
