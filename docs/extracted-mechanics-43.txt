const fs = require('fs');
const path = require('path');
const marked = require('marked'); // npm i marked

// Parse MD to tree (headers as keys)
function parseConvo(mdFile) {
  const content = fs.readFileSync(mdFile, 'utf8');
  const tokens = marked.lexer(content);
  const tree = { vision: [], mechanics: [], dev: [], beta: [] };
  let currentSection = 'vision';

  tokens.forEach(token => {
    if (token.type === 'heading' && token.depth === 2) {
      const text = token.text.toLowerCase();
      if (text.includes('world') || text.includes('core loop')) currentSection = 'vision';
      else if (text.includes('mechanics') || text.includes('trait')) currentSection = 'mechanics';
      else if (text.includes('stage') || text.includes('poc')) currentSection = 'dev';
      else if (text.includes('beta') || text.includes('balance')) currentSection = 'beta';
    } else if (token.type === 'paragraph' || token.type === 'list') {
      tree[currentSection].push(token.text || token.items?.map(i => i.text).join('\n'));
    }
  });
  return tree;
}

// Write nested MD/TS files
function writeFiles(tree, outDir = './docs') {
  fs.mkdirSync(outDir, { recursive: true });
  fs.mkdirSync(path.join(outDir, 'mechanics'), { recursive: true });
  fs.mkdirSync(path.join(outDir, 'dev'), { recursive: true });

  // Vision.md
  fs.writeFileSync(path.join(outDir, 'vision.md'), tree.vision.join('\n\n'));

  // Mechanics/Traits.md
  fs.writeFileSync(path.join(outDir, 'mechanics/traits.md'), tree.mechanics.join('\n\n'));

  // Dev/Stages.md
  fs.writeFileSync(path.join(outDir, 'dev/stages.md'), tree.dev.join('\n\n'));

  // Beta.md
  fs.writeFileSync(path.join(outDir, 'beta.md'), tree.beta.join('\n\n'));

  // TS Stubs (e.g., Evo Morph Hook)
  fs.writeFileSync(path.join('../src/hooks/useEvoMorph.ts'), `
export const useEvoMorph = (trait: string, prog: number) => {
  // POC: Morph prog 0-1, sync haptic/audio
  return { intensity: prog > 0.5 ? 0.5 : 0.2 }; // From vision
};
`);

  console.log('Unpacked! Check /docs & /src/hooks.');
}

// Run
const mdFile = process.argv[2] || 'convo.md';
writeFiles(parseConvo(mdFile));