<!DOCTYPE html>
<html>
<head>
    <title>Canvas 2D Raycasting Test - Click Molecules</title>
    <style>
        body { margin: 0; background: #0a0a1a; }
        canvas { display: block; cursor: crosshair; }
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            color: #00ff88;
            font-family: monospace;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border: 2px solid #00ff88;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="info">
        <h3>Raycast Test: Click on Atoms!</h3>
        <p id="status">Click an atom to select it</p>
        <p id="selected"></p>
    </div>
    
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const selectedDiv = document.getElementById('selected');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // O2 molecule (two red spheres)
        const atoms = [
            { element: 'O', x: -60, y: 0, z: 0, radius: 152, color: '#ff3333' },
            { element: 'O', x: 60, y: 0, z: 0, radius: 152, color: '#ff3333' }
        ];
        
        let rotation = 0;
        let selectedAtom = null;
        
        function project3D(x, y, z, rotY, rotX) {
            // Rotate around Y
            const cosY = Math.cos(rotY);
            const sinY = Math.sin(rotY);
            let x2 = x * cosY - z * sinY;
            let z2 = x * sinY + z * cosY;
            
            // Rotate around X
            const cosX = Math.cos(rotX);
            const sinX = Math.sin(rotX);
            const y2 = y * cosX - z2 * sinX;
            z2 = y * sinX + z2 * cosX;
            
            return { x: x2, y: y2, z: z2 };
        }
        
        // Raycast: Check if mouse clicked on atom
        function raycast(mouseX, mouseY, projected) {
            for (const atom of projected) {
                const dx = mouseX - atom.screenX;
                const dy = mouseY - atom.screenY;
                const distance = Math.sqrt(dx*dx + dy*dy);
                
                if (distance < atom.screenRadius) {
                    return atom;
                }
            }
            return null;
        }
        
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const hit = raycast(mouseX, mouseY, projected);
            
            if (hit) {
                selectedAtom = hit;
                status.textContent = `✅ HIT! Clicked on ${hit.element}`;
                selectedDiv.innerHTML = `
                    Element: ${hit.element}<br>
                    Position: (${hit.x.toFixed(0)}, ${hit.y.toFixed(0)}, ${hit.z.toFixed(0)})<br>
                    Screen: (${hit.screenX.toFixed(0)}, ${hit.screenY.toFixed(0)})<br>
                    Radius: ${hit.radius}pm
                `;
                console.log('✅ Raycasting works!', hit);
            } else {
                selectedAtom = null;
                status.textContent = 'Missed - click on an atom';
                selectedDiv.innerHTML = '';
            }
        });
        
        let projected = [];
        
        function render() {
            ctx.fillStyle = '#0a0a1a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = 1.5;
            
            rotation += 0.005;
            
            // Project atoms
            projected = atoms.map((atom, idx) => {
                const p = project3D(atom.x, atom.y, atom.z, rotation, rotation * 0.7);
                return {
                    index: idx,
                    element: atom.element,
                    color: atom.color,
                    radius: atom.radius,
                    x: atom.x,
                    y: atom.y,
                    z: atom.z,
                    screenX: centerX + p.x * scale,
                    screenY: centerY + p.y * scale,
                    screenRadius: atom.radius * scale,
                    depth: p.z
                };
            });
            
            // Sort by depth
            projected.sort((a, b) => a.depth - b.depth);
            
            // Draw bond
            if (projected.length === 2) {
                ctx.strokeStyle = '#666666';
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(projected[0].screenX, projected[0].screenY);
                ctx.lineTo(projected[1].screenX, projected[1].screenY);
                ctx.stroke();
            }
            
            // Draw atoms
            for (const atom of projected) {
                const isSelected = selectedAtom && selectedAtom.index === atom.index;
                
                // Gradient for 3D effect
                const gradient = ctx.createRadialGradient(
                    atom.screenX - atom.screenRadius * 0.3,
                    atom.screenY - atom.screenRadius * 0.3,
                    atom.screenRadius * 0.1,
                    atom.screenX,
                    atom.screenY,
                    atom.screenRadius
                );
                gradient.addColorStop(0, '#ffffff');
                gradient.addColorStop(0.3, atom.color);
                gradient.addColorStop(1, '#000000');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(atom.screenX, atom.screenY, atom.screenRadius, 0, Math.PI * 2);
                ctx.fill();
                
                // Selection highlight
                if (isSelected) {
                    ctx.strokeStyle = '#00ff88';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.arc(atom.screenX, atom.screenY, atom.screenRadius + 10, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // Label
                ctx.fillStyle = isSelected ? '#00ff88' : 'white';
                ctx.font = 'bold 24px monospace';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(atom.element, atom.screenX, atom.screenY);
            }
            
            requestAnimationFrame(render);
        }
        
        render();
        
        console.log('✅ Canvas 2D Raycasting test ready');
        console.log('Click on an oxygen atom to test hit detection');
    </script>
</body>
</html>

