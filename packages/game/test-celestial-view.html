<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celestial View Test</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; font-family: monospace; }
        #renderCanvas { width: 100%; height: 100vh; display: block; }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            line-height: 1.6;
        }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        button:hover { background: #00cc00; }
    </style>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <div id="info">
        <div><strong>CELESTIAL VIEW TEST</strong></div>
        <div id="cameraInfo">Camera Distance: --</div>
        <div id="lodInfo">LOD Mode: --</div>
        <div id="creatureInfo">Creatures: --</div>
        <div style="margin-top: 10px; color: #888;">
            Mouse Wheel: Zoom In/Out<br>
            Mouse Drag: Rotate<br>
            Range: 5 (surface) â†’ 500 (celestial)
        </div>
    </div>
    <div id="controls">
        <button onclick="zoomTo(5)">Surface View (5)</button>
        <button onclick="zoomTo(50)">Close (50)</button>
        <button onclick="zoomTo(100)">Threshold (100)</button>
        <button onclick="zoomTo(200)">Planetary (200)</button>
        <button onclick="zoomTo(500)">Celestial (500)</button>
    </div>

    <script type="module">
        import * as BABYLON from 'https://cdn.babylonjs.com/babylon.js';

        const canvas = document.getElementById('renderCanvas');
        const engine = new BABYLON.Engine(canvas, true);
        const scene = new BABYLON.Scene(engine);

        // Camera with extended range
        const camera = new BABYLON.ArcRotateCamera(
            'camera',
            -Math.PI / 2,
            Math.PI / 2.5,
            20,
            BABYLON.Vector3.Zero(),
            scene
        );
        camera.attachControl(canvas, true);
        camera.lowerRadiusLimit = 5;
        camera.upperRadiusLimit = 500;
        camera.wheelDeltaPercentage = 0.01;

        // Lighting
        const hemiLight = new BABYLON.HemisphericLight('hemiLight', new BABYLON.Vector3(0, 1, 0), scene);
        hemiLight.intensity = 0.3;
        const dirLight = new BABYLON.DirectionalLight('dirLight', new BABYLON.Vector3(-1, -1, -1), scene);
        dirLight.intensity = 1.2;

        // Planet
        const planet = BABYLON.MeshBuilder.CreateSphere('planet', { diameter: 10, segments: 64 }, scene);
        const planetMat = new BABYLON.PBRMaterial('planetMat', scene);
        planetMat.albedoColor = new BABYLON.Color3(0.3, 0.5, 0.7);
        planetMat.roughness = 0.7;
        planetMat.metallic = 0.1;
        planet.material = planetMat;

        // Create test creatures (20 points spread across planet surface)
        const creatures = [];
        const creatureLights = [];
        const creatureMeshes = [];

        for (let i = 0; i < 20; i++) {
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.random() * Math.PI;
            const radius = 5.2; // Just above planet surface

            const creature = {
                id: `creature-${i}`,
                position: new BABYLON.Vector3(
                    radius * Math.sin(phi) * Math.cos(theta),
                    radius * Math.sin(phi) * Math.sin(theta),
                    radius * Math.cos(phi)
                ),
                lineageColor: i < 10 ? '#00ff00' : (i < 15 ? '#ff0000' : '#0000ff'),
                vitality: 0.8 + Math.random() * 0.2
            };
            creatures.push(creature);

            // Create point light (initially hidden)
            const light = new BABYLON.PointLight(
                `light-${i}`,
                creature.position,
                scene
            );
            const color = BABYLON.Color3.FromHexString(creature.lineageColor);
            light.diffuse = color;
            light.specular = color;
            light.range = 2;
            light.intensity = creature.vitality * 0.5;
            light.setEnabled(false);
            creatureLights.push(light);

            // Create mesh (initially hidden)
            const mesh = BABYLON.MeshBuilder.CreateCapsule(
                `mesh-${i}`,
                { radius: 0.3, height: 1 },
                scene
            );
            mesh.position = creature.position.clone();
            const meshMat = new BABYLON.StandardMaterial(`mat-${i}`, scene);
            meshMat.diffuseColor = color;
            meshMat.emissiveColor = color.scale(0.3);
            mesh.material = meshMat;
            mesh.setEnabled(false);
            creatureMeshes.push(mesh);
        }

        // LOD system
        let currentLOD = null;

        function updateLOD() {
            const distance = BABYLON.Vector3.Distance(camera.position, BABYLON.Vector3.Zero());
            const threshold = 100;
            const newLOD = distance > threshold ? 'lights' : 'meshes';

            if (newLOD !== currentLOD) {
                if (newLOD === 'lights') {
                    // Switch to lights
                    creatureMeshes.forEach(m => m.setEnabled(false));
                    creatureLights.forEach(l => l.setEnabled(true));
                } else {
                    // Switch to meshes
                    creatureLights.forEach(l => l.setEnabled(false));
                    creatureMeshes.forEach(m => m.setEnabled(true));
                }
                currentLOD = newLOD;
            }

            // Update info display
            document.getElementById('cameraInfo').textContent = `Camera Distance: ${distance.toFixed(1)} units`;
            document.getElementById('lodInfo').textContent = `LOD Mode: ${currentLOD} (threshold: 100)`;
            document.getElementById('creatureInfo').textContent = 
                `Creatures: ${creatures.length} (${currentLOD === 'lights' ? 'point lights' : '3D meshes'})`;
        }

        // Animation loop
        scene.registerBeforeRender(() => {
            updateLOD();
            planet.rotation.y += 0.001; // Slow rotation
        });

        // Zoom helper function
        window.zoomTo = function(distance) {
            const duration = 1000; // ms
            const start = camera.radius;
            const startTime = Date.now();

            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3); // Ease out cubic

                camera.radius = start + (distance - start) * eased;

                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            };

            animate();
        };

        // Render loop
        engine.runRenderLoop(() => {
            scene.render();
        });

        window.addEventListener('resize', () => {
            engine.resize();
        });

        // Initial update
        updateLOD();
    </script>
</body>
</html>
